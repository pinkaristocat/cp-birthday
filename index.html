<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Happy Birthday ‚Äì Pink Cake</title>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
  body {
    margin: 0;
    background: radial-gradient(circle at top, #ffc4e1, #ff9fcf);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    font-family: "Poppins", sans-serif;
    text-align: center;
    overflow: hidden;
  }

  #countdown {
    font-size: 2rem;
    margin-bottom: 20px;
  }

  #openBtn {
    padding: 12px 28px;
    font-size: 1.2rem;
    border: none;
    border-radius: 8px;
    background-color: #ff6b6b;
    color: #fff;
    cursor: pointer;
    transition: transform 0.2s;
    display:none; /* Hidden until countdown ends */
  }
  #openBtn:hover { transform: scale(1.08); }

  .cake-container { position: relative; display: none; }

  model-viewer {
    width: 400px;
    height: 400px;
    opacity: 0;
    transition: opacity 0.5s ease-in;
  }

  /* Candles */
  .candles {
    position: absolute;
    top: 110px;
    left: 50%;
    transform: translateX(-50%);
    display: none;
    gap: 40px;
    pointer-events: none;
  }
  .candle { display: flex; flex-direction: column; align-items: center; }
  .candle-body {
    width: 10px; height: 35px; border-radius: 4px;
    background: linear-gradient(to bottom, #ffd3d3, #ff9fcf);
    box-shadow: 0 0 3px rgba(0,0,0,0.2); margin-top: 5px;
  }
  .flame {
    width: 10px; height: 18px;
    background: radial-gradient(ellipse at center, #ffeb3b 0%, #ff5722 70%);
    border-radius: 50% 50% 35% 35%;
    animation: flicker 0.25s infinite alternate;
  }
  @keyframes flicker {
    0% { transform: scaleY(1) scaleX(1); opacity: 0.9; }
    100% { transform: scaleY(1.3) scaleX(0.8); opacity: 0.6; }
  }

  /* Messages */
  #hintMessage { font-size: 1.5rem; margin-top: 20px; display:none; }
  #bigMessage {
    display: none; font-size: 3rem; font-weight: bold; color: #e63946;
    text-shadow: 0 0 12px rgba(255, 0, 120, 0.5); margin-bottom: 10px;
    opacity: 0; animation: pulse 2s infinite alternate; transition: opacity 1s ease-in;
  }
  @keyframes pulse {
    0% { text-shadow: 0 0 10px rgba(255,0,120,0.6); }
    100% { text-shadow: 0 0 20px rgba(255,255,255,0.8); }
  }
  .fade-in { opacity: 0; animation: fadeIn 2s forwards; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
  #extraMessage, #finalMessage { display:none; font-size:2rem; color:#ff3b8d; font-weight:600; margin-top:5px; line-height:1.1; }

  /* Balloons */
  .balloon {
    position: absolute; bottom: -80px; width: 40px; height: 60px;
    border-radius: 50%; opacity: 0.9; z-index: 999;
    animation: floatUp 6s ease-out forwards;
  }
  @keyframes floatUp {
    0% { transform: translateY(0) translateX(0); opacity:1; }
    100% { transform: translateY(-110vh) translateX(var(--sway,0px)); opacity:0; }
  }
</style>
</head>
<body>

<div id="countdown"></div>
<button id="openBtn">Open Cake!</button>

<div id="bigMessage">Happy Birthday Daddy ‚ù§Ô∏è</div>
<div id="extraMessage">Eat me out</div>
<div id="finalMessage">...I mean the cake üòá</div>

<div class="cake-container" id="cakeContainer">
  <model-viewer id="cake3d" src="cake.glb" alt="3D Birthday Cake"
    camera-controls ar ar-modes="webxr scene-viewer quick-look" preload></model-viewer>

  <div class="candles" id="candles">
    <div class="candle"><div class="flame"></div><div class="candle-body"></div></div>
    <div class="candle"><div class="flame"></div><div class="candle-body"></div></div>
    <div class="candle"><div class="flame"></div><div class="candle-body"></div></div>
  </div>
</div>

<div id="hintMessage">Blow on the cake....like literally</div>

<script>
const countdownEl = document.getElementById('countdown');
const openBtn = document.getElementById('openBtn');
const cakeContainer = document.getElementById('cakeContainer');
const cake3d = document.getElementById('cake3d');
const hintMessage = document.getElementById('hintMessage');
const candles = document.getElementById('candles');
const bigMessage = document.getElementById('bigMessage');
const extraMessage = document.getElementById('extraMessage');
const finalMessage = document.getElementById('finalMessage');
let candlesLit = true;

// Countdown until 23rd October 00:00 CET
const targetDate = new Date(Date.UTC(new Date().getFullYear(), 9, 22, 22, 0, 0)); 
function updateCountdown(){
  const now = new Date();
  let diff = targetDate - now;
  if(diff <= 0){
    countdownEl.style.display = 'none';
    openBtn.style.display = 'inline-block';
    clearInterval(countdownInterval);
    return;
  }
  const days = Math.floor(diff / (1000*60*60*24));
  const hours = Math.floor((diff / (1000*60*60)) % 24);
  const minutes = Math.floor((diff / (1000*60)) % 60);
  const seconds = Math.floor((diff / 1000) % 60);
  countdownEl.textContent = `üéâ Cake available in ${days}d ${hours}h ${minutes}m ${seconds}s üéâ`;
}
updateCountdown();
const countdownInterval = setInterval(updateCountdown,1000);

// Show cake container & confetti
openBtn.addEventListener('click', ()=>{
  openBtn.style.display='none';
  cakeContainer.style.display='block';

  const duration = 4000;
  const end = Date.now() + duration;
  (function frame() {
    confetti({ particleCount:8, angle:60, spread:55, origin:{x:0} });
    confetti({ particleCount:8, angle:120, spread:55, origin:{x:1} });
    if(Date.now()<end) requestAnimationFrame(frame);
  })();
});

// Show cake & candles together when model loads
cake3d.addEventListener('load', ()=>{
  cake3d.style.opacity='1';
  candles.style.display='flex';
  hintMessage.style.display='block';
  initBlowDetection();
});

// Blow detection
async function initBlowDetection(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioContext.createMediaStreamSource(stream);
    const analyser = audioContext.createAnalyser();
    source.connect(analyser);
    analyser.fftSize = 256;
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    function detectBlow(){
      analyser.getByteFrequencyData(dataArray);
      let sum = 0;
      for(let i=0;i<dataArray.length;i++) sum+=dataArray[i];
      const avg = sum/dataArray.length;
      if(avg>50 && candlesLit) blowCandles();
      if(candlesLit) requestAnimationFrame(detectBlow);
    }
    detectBlow();
  }catch(err){
    alert('Microphone access is needed to blow out the candles!');
  }
}

// Balloons
function createBalloon(){
  const balloon = document.createElement('div');
  balloon.classList.add('balloon');
  const colors = ['#ff3b8d','#ffb3c1','#ff6b6b','#ff9fcf','#ffe066'];
  balloon.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
  balloon.style.left = Math.random()*90+'vw';
  balloon.style.setProperty('--sway',(Math.random()*100-50)+'px');
  document.body.appendChild(balloon);
  setTimeout(()=>balloon.remove(),6000);
}
function launchBalloons(count=15){
  for(let i=0;i<count;i++){ setTimeout(createBalloon,i*300); }
}

// Blow candles & show messages
function blowCandles(){
  candlesLit=false;
  cake3d.style.filter="brightness(0.7)";
  hintMessage.style.display='none';
  candles.querySelectorAll('.flame').forEach(f=>f.style.display='none');

  bigMessage.style.display='block';
  setTimeout(()=>bigMessage.style.opacity='1',100);

  setTimeout(()=>{ extraMessage.style.display='block'; extraMessage.classList.add('fade-in'); },3000);
  setTimeout(()=>{ finalMessage.style.display='block'; finalMessage.classList.add('fade-in'); },7000);

  launchBalloons();
}
</script>
</body>
</html>
